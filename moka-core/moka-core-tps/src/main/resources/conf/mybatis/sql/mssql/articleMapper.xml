<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jmnet.moka.core.tps.mvc.article.mapper.ArticleMapper">

	<sql id="findAllWhere">
		WHERE
		<!-- 미디어 조건 -->
		ARTICLE.MEDIA_ID = #{mediaId}
		<!-- 검색 조건 -->
		<if test="keyword != null and keyword != ''">
			<choose>
				<when test="searchType == 'contentsId'">
					AND ARTICLE.CONTENTS_ID = ${keyword}
				</when>
				<when test="searchType == 'title'">
					AND ARTICLE.TITLE LIKE '%${keyword}%'
				</when>
				<when test="searchType == 'all'">
					AND (ARTICLE.CONTENTS_ID = #{keyword} OR ARTICLE.TITLE LIKE '%${keyword}%')
				</when>
			</choose>
		</if>
		<!-- 배부일 조건(문자열 날짜 크기 비교를 이렇게 해도 되는지???) -->
		<if test="distStartYmdt != null and distStartYmdt != null and distEndYmdt != null and distEndYmdt != null">
			AND ARTICLE.DIST_YMDT <![CDATA[>=]]> #{distStartYmdt}
			AND ARTICLE.DIST_YMDT <![CDATA[<=]]> #{distEndYmdt}
		</if>
		<!-- 부서 조건 -->
		<!-- 언어(기타코드) 조건 -->
		<if test="lang != null and lang != ''">
			AND ARTICLE.lang = #{lang}
		</if>
		<!-- 분류코드(기타코드) 조건 -->
		<if test="codeId != null and codeId != ''">
			<choose>
				<!-- 대분류일 때 -->
				<when test="codeId.endsWith('00000')">
					AND CONTENTS_CODE.CODE_ID LIKE '${codeId.substring(0,2)}%'
				</when>
				<!-- 중분류일 때 -->
				<when test="codeId.endsWith('000')">
					AND CONTENTS_CODE.CODE_ID LIKE '${codeId.substring(0,4)}%'
				</when>
				<!-- 그외 -->
				<otherwise>
					AND CONTENTS_CODE.CODE_ID = #{codeId}
				</otherwise>
			</choose>
		</if>
		<!-- 서비스타입(기타코드) 조건 -->
		<if test="serviceType != null and serviceType != ''">
			AND ARTICLE.SERVICE_TYPE = #{serviceType}
		</if>
		<!-- 서비스 중인 기사만 -->
		AND ARTICLE.SERVICE_YN = "Y"
	</sql>
	
	<sql id="findAllOrder">
		<if test="sortByColumn != null">
			ORDER BY
			<foreach open="" close="" collection="sortByColumn" item="sortItem" separator=",">
				${sortItem}
			</foreach>
		</if>
	</sql>
	
	<select id="findAll" parameterType="articleSearchDTO" resultType="articleVO">
		SELECT DISTINCT *
		FROM WMS_ARTICLE AS ARTICLE
		JOIN WMS_CONTENTS_CODE AS CONTENTS_CODE
		ON ARTICLE.CONTENTS_ID = CONTENTS_CODE.CONTENTS_ID
		<include refid="findAllWhere" />
		<include refid="findAllOrder" />
	</select>
	
	<select id="count" parameterType="articleSearchDTO" resultType="java.lang.Long">
		SELECT 
			COUNT(ARTICLE.SEQ) AS TOTAL_CNT
		FROM WMS_ARTICLE AS ARTICLE
		JOIN WMS_CONTENTS_CODE AS CONTENTS_CODE
		ON ARTICLE.CONTENTS_ID = CONTENTS_CODE.CONTENTS_ID
		<include refid="findAllWhere"/>
	</select>
	
</mapper>